name: E2E Tests (Manual)

# Manual trigger for running E2E tests against any environment

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - localhost
          - production
          - custom
        default: localhost
      custom_url:
        description: 'Custom URL (only used when target=custom)'
        required: false
        type: string
      test_suite:
        description: 'Test suite to run'
        required: true
        type: choice
        options:
          - all
          - smoke
          - mock
        default: all
      browser:
        description: 'Browser to use'
        required: true
        type: choice
        options:
          - chrome
          - firefox
          - webkit
          - all
        default: chrome

jobs:
  e2e:
    name: E2E Tests (${{ inputs.target }} / ${{ inputs.test_suite }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.target == 'production' && 'production' || '' }}
    # Use Playwright Docker image for production/custom (no Docker build needed)
    container: ${{ inputs.target != 'localhost' && 'mcr.microsoft.com/playwright:v1.57.0-noble' || '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine target URL
        id: url
        run: |
          case "${{ inputs.target }}" in
            localhost)
              echo "SERVICE_URL=http://localhost:5000" >> "$GITHUB_OUTPUT"
              echo "BACKEND_URL=http://localhost:8000" >> "$GITHUB_OUTPUT"
              echo "NEED_SERVICES=true" >> "$GITHUB_OUTPUT"
              ;;
            production)
              echo "SERVICE_URL=${{ secrets.PRODUCTION_URL }}" >> "$GITHUB_OUTPUT"
              echo "BACKEND_URL=" >> "$GITHUB_OUTPUT"
              echo "NEED_SERVICES=false" >> "$GITHUB_OUTPUT"
              ;;
            custom)
              echo "SERVICE_URL=${{ inputs.custom_url }}" >> "$GITHUB_OUTPUT"
              echo "BACKEND_URL=" >> "$GITHUB_OUTPUT"
              echo "NEED_SERVICES=false" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Set up Docker Buildx
        if: steps.url.outputs.NEED_SERVICES == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Start local services
        if: steps.url.outputs.NEED_SERVICES == 'true'
        run: |
          if [ "${{ inputs.test_suite }}" = "mock" ]; then
            MOCK_ESPN=true docker compose up -d --build --wait
          else
            docker compose up -d --build --wait
          fi

      # For production/custom: install Bun in Playwright container
      - name: Install Bun (Playwright container)
        if: steps.url.outputs.NEED_SERVICES == 'false'
        run: |
          apt-get update && apt-get install -y unzip curl
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> "$GITHUB_PATH"

      # For localhost: use setup-bun action
      - name: Setup Bun (localhost)
        if: steps.url.outputs.NEED_SERVICES == 'true'
        uses: oven-sh/setup-bun@v2

      - name: Install E2E dependencies
        working-directory: ./e2e
        run: bun install

      # Only install browsers for localhost (Playwright image has them pre-installed)
      - name: Install Playwright browsers
        if: steps.url.outputs.NEED_SERVICES == 'true'
        working-directory: ./e2e
        run: |
          if [ "${{ inputs.browser }}" = "all" ]; then
            bunx playwright install --with-deps
          else
            bunx playwright install ${{ inputs.browser }} --with-deps
          fi

      - name: Run E2E tests
        working-directory: ./e2e
        env:
          SERVICE_URL: ${{ steps.url.outputs.SERVICE_URL }}
          BACKEND_URL: ${{ steps.url.outputs.BACKEND_URL }}
          MOCK_ESPN: ${{ inputs.test_suite == 'mock' && 'true' || '' }}
          CI: 'true'
        run: |
          # Determine test command
          case "${{ inputs.test_suite }}" in
            smoke)
              TEST_CMD="test:smoke"
              ;;
            mock|all)
              TEST_CMD="test"
              ;;
          esac

          # Determine browser project
          if [ "${{ inputs.browser }}" = "all" ]; then
            BROWSER_ARGS=""
          else
            BROWSER_ARGS="--project=${{ inputs.browser }}"
          fi

          echo "Running: bun run $TEST_CMD $BROWSER_ARGS"
          bun run $TEST_CMD $BROWSER_ARGS

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.target }}-${{ inputs.test_suite }}
          path: e2e/playwright-report/

      - name: Stop services
        if: always() && steps.url.outputs.NEED_SERVICES == 'true'
        run: docker compose down

