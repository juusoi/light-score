name: E2E Tests (Manual)

# Manual trigger for running E2E tests against any environment
# Also callable from other workflows (e.g., post-deploy smoke tests)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - localhost
          - production
          - custom
        default: localhost
      custom_url:
        description: 'Custom URL (only used when target=custom)'
        required: false
        type: string
      test_suite:
        description: 'Test suite to run'
        required: true
        type: choice
        options:
          - all
          - smoke
          - mock
        default: all
      browser:
        description: 'Browser to use'
        required: true
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
        default: chromium

  # Reusable workflow - can be called from other workflows
  workflow_call:
    inputs:
      target:
        description: 'Target environment'
        required: true
        type: string
      custom_url:
        description: 'Custom URL (only used when target=custom)'
        required: false
        type: string
      test_suite:
        description: 'Test suite to run'
        required: true
        type: string
      browser:
        description: 'Browser to use'
        required: false
        type: string
        default: chromium
    secrets:
      PRODUCTION_URL:
        description: 'Production URL secret'
        required: false

# NOTE: Playwright version should match e2e/package.json @playwright/test version
# Update the container image version below when upgrading Playwright

jobs:
  e2e:
    name: E2E Tests (${{ inputs.target }} / ${{ inputs.test_suite }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.target == 'production' && 'production' || '' }}
    # Use Playwright Docker image for production/custom (no Docker build needed)
    # Version: keep in sync with e2e/package.json @playwright/test
    container: ${{ inputs.target != 'localhost' && 'mcr.microsoft.com/playwright:v1.57.0-noble' || '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Determine target URL
        id: url
        run: |
          case "${{ inputs.target }}" in
            localhost)
              echo "SERVICE_URL=http://localhost:5000" >> "$GITHUB_OUTPUT"
              echo "BACKEND_URL=http://localhost:8000" >> "$GITHUB_OUTPUT"
              echo "NEED_SERVICES=true" >> "$GITHUB_OUTPUT"
              ;;
            production)
              echo "SERVICE_URL=${{ secrets.PRODUCTION_URL }}" >> "$GITHUB_OUTPUT"
              echo "BACKEND_URL=" >> "$GITHUB_OUTPUT"
              echo "NEED_SERVICES=false" >> "$GITHUB_OUTPUT"
              ;;
            custom)
              echo "SERVICE_URL=${{ inputs.custom_url }}" >> "$GITHUB_OUTPUT"
              echo "BACKEND_URL=" >> "$GITHUB_OUTPUT"
              echo "NEED_SERVICES=false" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Set up Docker Buildx
        if: steps.url.outputs.NEED_SERVICES == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Start local services
        if: steps.url.outputs.NEED_SERVICES == 'true'
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
        run: |
          if [ "${{ inputs.test_suite }}" = "mock" ]; then
            MOCK_ESPN=true docker compose up -d --build --wait
          else
            docker compose up -d --build --wait
          fi

      # For production/custom: install Bun in Playwright container
      - name: Install Bun (Playwright container)
        if: steps.url.outputs.NEED_SERVICES == 'false'
        run: |
          apt-get update && apt-get install -y unzip curl
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> "$GITHUB_PATH"

      # For localhost: use setup-bun action
      - name: Setup Bun (localhost)
        if: steps.url.outputs.NEED_SERVICES == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            e2e/node_modules
          key: ${{ runner.os }}-bun-manual-${{ hashFiles('e2e/package.json', 'e2e/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-manual-
            ${{ runner.os }}-bun-

      - name: Install E2E dependencies
        working-directory: ./e2e
        run: bun install --frozen-lockfile

      # Only install browsers for localhost (Playwright image has them pre-installed)
      - name: Cache Playwright browsers
        if: steps.url.outputs.NEED_SERVICES == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-manual-${{ hashFiles('e2e/package.json') }}-${{ inputs.browser }}
          restore-keys: |
            ${{ runner.os }}-playwright-manual-
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: steps.url.outputs.NEED_SERVICES == 'true'
        working-directory: ./e2e
        run: |
          if [ "${{ inputs.browser }}" = "all" ]; then
            bunx playwright install --with-deps
          else
            bunx playwright install ${{ inputs.browser }} --with-deps
          fi

      - name: Run E2E tests
        working-directory: ./e2e
        env:
          SERVICE_URL: ${{ steps.url.outputs.SERVICE_URL }}
          BACKEND_URL: ${{ steps.url.outputs.BACKEND_URL }}
          MOCK_ESPN: ${{ inputs.test_suite == 'mock' && 'true' || '' }}
          CI: 'true'
        run: |
          # Determine test command
          case "${{ inputs.test_suite }}" in
            smoke)
              TEST_CMD="test:smoke"
              ;;
            mock|all)
              TEST_CMD="test"
              ;;
          esac

          # Determine browser project
          if [ "${{ inputs.browser }}" = "all" ]; then
            BROWSER_ARGS=""
          else
            BROWSER_ARGS="--project=${{ inputs.browser }}"
          fi

          echo "Running: bun run $TEST_CMD $BROWSER_ARGS"
          bun run "$TEST_CMD" $BROWSER_ARGS

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.target }}-${{ inputs.test_suite }}
          path: e2e/playwright-report/

      - name: Stop services
        if: always() && steps.url.outputs.NEED_SERVICES == 'true'
        run: docker compose down

