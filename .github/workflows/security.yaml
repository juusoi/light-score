name: Security checks

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]

permissions:
  contents: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    # Only run if CI workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    strategy:
      fail-fast: false
      matrix:
        tool: [bandit, pip-audit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: latest

      - name: Create virtual environment
        run: uv venv

      - name: Install security tools
        run: |
          case "${{ matrix.tool }}" in
            bandit)
              uv pip install -e .[security]
              ;;
            pip-audit)
              uv pip install -e .[security]
              ;;
          esac

      - name: Run security scan - ${{ matrix.tool }}
        run: |
          case "${{ matrix.tool }}" in
            bandit)
              echo "üîç Running Bandit security scan..."
              bandit -r backend frontend functions -f json -o bandit-report.json || true
              bandit -r backend frontend functions -q
              ;;
            pip-audit)
              echo "üîç Running pip-audit dependency scan..."
              # Install project dependencies first for better audit
              ./scripts/uv-sync.sh --all
              pip-audit --desc --output=json --output-file=pip-audit-report.json || true
              pip-audit --desc
              ;;
          esac

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ matrix.tool }}
          path: '*-report.json'
          retention-days: 30
