name: Security checks

on:
  # Run directly on PRs targeting main for fast feedback
  pull_request:
    branches: [main]
  # Run after CI completes (for merges/rebases) to gate deploy path
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    # Run only when:
    # 1. It's a PR event (target main) OR
    # 2. A completed CI workflow_run on main concluded successfully
    if: >-
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    strategy:
      fail-fast: false
      matrix:
        tool: [bandit, pip-audit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'uv'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: latest
          enable-cache: true

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Setup environment and install dependencies
        run: |
          uv venv
          ./scripts/uv-sync.sh --all

      - name: Install security tools
        run: |
          case "${{ matrix.tool }}" in
            bandit)
              uv pip install bandit
              ;;
            pip-audit)
              uv pip install pip-audit
              ;;
          esac

      - name: Run security scan - ${{ matrix.tool }}
        run: |
          case "${{ matrix.tool }}" in
            bandit)
              echo "üîç Running Bandit security scan..."
              .venv/bin/bandit -r backend frontend functions \
                --exclude "*/utest/*,*/test_*,*test*.py" \
                -f json -o bandit-report.json || true
              .venv/bin/bandit -r backend frontend functions \
                --exclude "*/utest/*,*/test_*,*test*.py" \
                -q
              ;;
            pip-audit)
              echo "üîç Running pip-audit dependency scan..."
              # Ignore GHSA-4xh5-x5gv-qwph: pip tarfile vulnerability fixed in upcoming pip 25.3
              .venv/bin/pip-audit --desc --ignore-vuln GHSA-4xh5-x5gv-qwph --output=json --output-file=pip-audit-report.json || true
              .venv/bin/pip-audit --desc --ignore-vuln GHSA-4xh5-x5gv-qwph
              ;;
          esac

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ matrix.tool }}
          path: '*-report.json'
          retention-days: 30
